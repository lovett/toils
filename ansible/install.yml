---
- hosts: toils
  vars:
    application_name: toils
  tasks:
    - name: Build production container image
      local_action:
        module: make
        chdir: "{{ playbook_dir }}/../"
        target: image

    - name: Push container image to registry
      local_action:
        module: command
        argv:
          - buildah
          - push
          - "{{ application_name }}"
          - "{{ container_registry }}/{{ application_name }}:latest"

    - name: Pull new container image
      command: /usr/bin/podman pull "{{ container_registry }}/{{ application_name }}:latest"

    - name: Stop service
      systemd:
        scope: user
        name: "{{ application_name }}"
        state: stopped

    - name: Install systemd service
      become: true
      template:
        src: "templates/systemd-service.j2"
        dest: ".config/systemd/user/{{ application_name }}.service"

    - name: Start systemd service
      systemd:
        scope: user
        daemon_reload: yes
        enabled: yes
        masked: no
        name: "{{ application_name }}"
        state: started
